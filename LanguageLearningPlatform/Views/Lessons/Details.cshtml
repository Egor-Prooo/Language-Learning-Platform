@model LanguageLearningPlatform.Data.Models.Lesson

@{
    ViewData["Title"] = Model.Title;
    var courseLessons = ViewBag.CourseLessons as List<LanguageLearningPlatform.Data.Models.Lesson>;
    var currentIndex = ViewBag.CurrentLessonIndex as int? ?? 0;
    var hasNext = currentIndex < (courseLessons?.Count - 1 ?? 0);
    var hasPrevious = currentIndex > 0;
}

<div class="container my-4">
    <div class="row g-4">

        <!-- MAIN CONTENT -->
        <div class="col-lg-8">

            <!-- Page Header -->
            <div class="page-header mb-4">
                <nav aria-label="breadcrumb" class="mb-2">
                    <ol class="breadcrumb mb-0" style="font-size: 0.875rem;">
                        <li class="breadcrumb-item"><a asp-controller="Courses" asp-action="MyCourses">My Courses</a></li>
                        <li class="breadcrumb-item">
                            <a asp-controller="Courses" asp-action="Details" asp-route-id="@Model.CourseId">
                                @Model.Course.Title
                            </a>
                        </li>
                        <li class="breadcrumb-item active">@Model.Title</li>
                    </ol>
                </nav>

                <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="badge text-white" style="background: var(--primary-color); padding: 0.4rem 0.85rem;">
                        Lesson @Model.OrderIndex
                    </span>
                    <span class="badge bg-light text-dark">@Model.DurationMinutes min</span>
                    @if (Model.Exercises.Any())
                    {
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-dumbbell me-1"></i>@Model.Exercises.Count exercises
                        </span>
                    }
                </div>

                <h1 class="mb-1" style="font-size: 1.75rem;">@Model.Title</h1>
                <p class="text-secondary mb-0">@Model.Description</p>
            </div>

            <!-- Lesson Content -->
            <div class="content-section">
                <div class="content-section-title">
                    <i class="fas fa-book-open text-primary"></i> Lesson Material
                </div>
                <div class="lesson-content">
                    @Html.Raw(Model.Content)
                </div>
            </div>

            <!-- Exercises CTA -->
            @if (Model.Exercises.Any())
            {
                <div class="content-section">
                    <div class="content-section-title">
                        <i class="fas fa-dumbbell text-primary"></i> Practice Exercises
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3" style="background: rgba(79,70,229,0.06); border: 1px solid rgba(79,70,229,0.15);">
                                <div class="fw-bold text-primary" style="font-size: 1.5rem;">@Model.Exercises.Count</div>
                                <div class="text-secondary small">Exercises</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 rounded-3" style="background: rgba(245,158,11,0.06); border: 1px solid rgba(245,158,11,0.15);">
                                <div class="fw-bold" style="font-size: 1.5rem; color: var(--accent-color);">
                                    @Model.Exercises.Sum(e => e.Points)
                                </div>
                                <div class="text-secondary small">Points Available</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mb-4">
                        @foreach (var type in Model.Exercises.Select(e => e.Type).Distinct())
                        {
                            <span class="exercise-type-badge">
                                @switch (type)
                                {
                                    case "MultipleChoice":
                                        <i class="fas fa-list-ul"></i>
                                        <text>Multiple Choice</text>
                 break;
                                    case "Translation":
                                        <i class="fas fa-language"></i>
                                        <text>Translation</text>
                    break;
                                    case "FillInBlank":
                                        <i class="fas fa-keyboard"></i>
                                        <text>Fill in Blank</text>
                  break;
                                    default:
                                        <text>@type</text>
                                        break;
                                }
                            </span>
                        }
                    </div>

                    <a asp-action="Exercises" asp-route-id="@Model.Id" class="btn btn-enroll">
                        <i class="fas fa-play-circle me-2"></i>Start Exercises
                    </a>
                </div>
            }
            else
            {
                <div class="alert alert-light border">
                    <i class="fas fa-info-circle me-2 text-secondary"></i>
                    No exercises for this lesson yet.
                </div>
            }

            <!-- Prev / Next Navigation -->
            <div class="d-flex justify-content-between mt-2">
                @if (hasPrevious && courseLessons != null)
                {
                    var prev = courseLessons[currentIndex - 1];
                    <a asp-action="Details" asp-route-id="@prev.Id" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </a>
                }
                else
                {

                    <div></div>
                }

                @if (hasNext && courseLessons != null)
                {
                    var next = courseLessons[currentIndex + 1];
                    <a asp-action="Details" asp-route-id="@next.Id" class="btn btn-enroll">
                        Next Lesson<i class="fas fa-arrow-right ms-2"></i>
                    </a>
                }
                else
                {
                    <a asp-controller="Courses" asp-action="Details" asp-route-id="@Model.CourseId"
                       class="btn btn-success">
                        <i class="fas fa-check-circle me-2"></i>Back to Course
                    </a>
                }
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="col-lg-4">
            <div class="sidebar-panel">
                <div class="fw-bold mb-3" style="font-size: 1rem;">
                    <i class="fas fa-list me-2 text-primary"></i>Course Lessons
                </div>

                @if (courseLessons != null && courseLessons.Any())
                {
                    <div class="d-flex flex-column">
                        @for (int i = 0; i < courseLessons.Count; i++)
                        {
                            var lesson = courseLessons[i];
                            var isActive = i == currentIndex;

                            <a asp-action="Details" asp-route-id="@lesson.Id"
                               class="lesson-nav-item @(isActive ? "active" : "")">
                                <div class="lesson-nav-num">
                                    @if (isActive)
                                    {
                                        <i class="fas fa-play" style="font-size: 0.65rem;"></i>
                                    }
                                    else
                                    {
                                        <span>@lesson.OrderIndex</span>
                                    }
                                </div>
                                <div class="flex-grow-1 min-w-0">
                                    <div class="text-truncate">@lesson.Title</div>
                                    <div class="text-secondary" style="font-size: 0.75rem;">
                                        @lesson.DurationMinutes min
                                        @if (lesson.IsLocked)
                                        {
                                            <i class="fas fa-lock ms-1"></i>
                                        }
                                    </div>
                                </div>
                            </a>
                        }
                    </div>

                    <hr class="my-3" />
                }

                <!-- Progress summary -->
                <div class="d-flex justify-content-between small text-secondary">
                    <span>Lesson @(currentIndex + 1) of @courseLessons?.Count</span>
                    <span>@(Math.Round((currentIndex + 1.0) / (courseLessons?.Count ?? 1) * 100))% through</span>
                </div>
                <div class="progress-custom mt-2">
                    <div class="progress-bar-custom"
                         style="width: @(Math.Round((currentIndex + 1.0) / (courseLessons?.Count ?? 1) * 100))%">
                    </div>
                </div>

                <hr class="my-3" />

                <a asp-controller="Courses" asp-action="Details" asp-route-id="@Model.CourseId"
                   class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-arrow-left me-2"></i>Back to Course
                </a>
            </div>
        </div>
    </div>
</div>